<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Monitoring - Real Time Dashboard</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="manifest" href="manifest.json" />
    <script src="analysis.js"></script>
    <script src="campus.js"></script>
    <script src="auth.js"></script>
    <script src="db.js"></script>
    <script src="research.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="container" id="main-content" tabindex="-1">
        <header class="header" role="banner">
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                <i class="fas fa-moon" id="moonIcon"></i>
                <i class="fas fa-sun" id="sunIcon" style="display:none;"></i>
            </button>

            <div style="position: absolute; right: 40px; top: 80px; display: flex; align-items: center;">
                <button class="nav-btn" id="langBtn">EN/ML</button>
                <button class="nav-btn admin-only" id="settingsBtn" style="display:none;"><i class="fas fa-cog"></i>
                    Settings</button>
                <button class="nav-btn" id="loginBtn">View Mode</button>
            </div>

            <h1 data-i18n="title">Air Quality Monitoring Dashboard</h1>
            <p data-i18n="status">Real-time Air Quality Monitoring System</p>
        </header>

        <div class="status-bar" role="status" aria-live="polite">
            <div class="connection-status">
                <div class="status-dot" id="connectionDot" aria-hidden="true"></div>
                <span id="connectionStatus">Connecting to MQTT Broker...</span>
            </div>
            <span id="lastUpdate">Last Update: --:--:--</span>
        </div>

        <!-- NEW: Ventilation Recommendation Banner -->
        <div id="recommenderPanel" class="section" style="margin-bottom: 30px; border-left: 5px solid var(--accent);">
            <h3><i class="fas fa-robot"></i> AI Ventilation Recommendatons</h3>
            <p id="ventilationText">Analyzing air composition...</p>
        </div>

        <section class="dashboard" aria-labelledby="dashboard-heading">
            <h2 id="dashboard-heading" class="visually-hidden">Current Sensor Readings</h2>

            <!-- Existing Cards -->
            <article class="sensor-card" aria-labelledby="pm25-title">
                <div class="sensor-header">
                    <span class="sensor-title" id="pm25-title"><i class="fas fa-smog" aria-hidden="true"></i>
                        PM2.5</span>
                    <span class="aqi-indicator aqi-good" id="pm25Status">Good</span>
                </div>
                <div class="sensor-value" id="pm25Value" aria-live="polite">-- <span class="sensor-unit">μg/m³</span>
                </div>
                <div class="sensor-footer">
                    <span>Status:</span>
                    <span id="pm25Text">Excellent</span>
                </div>
            </article>

            <article class="sensor-card" aria-labelledby="co2-title">
                <div class="sensor-header">
                    <span class="sensor-title" id="co2-title"><i class="fas fa-cloud" aria-hidden="true"></i> CO2</span>
                    <span class="aqi-indicator aqi-good" id="co2Status">Good</span>
                </div>
                <div class="sensor-value" id="co2Value" aria-live="polite">-- <span class="sensor-unit">ppm</span></div>
                <div class="sensor-footer">
                    <span>Occupancy Est:</span>
                    <span id="occupancyEst">-- Students</span>
                </div>
            </article>



            <!-- New AI Prediction Card -->
            <article class="sensor-card" aria-labelledby="pred-title" style="border-color: var(--accent);">
                <div class="sensor-header">
                    <span class="sensor-title" id="pred-title"><i class="fas fa-crystal-ball" aria-hidden="true"></i>
                        Forecast</span>
                    <span class="aqi-indicator aqi-moderate" id="predStatus">Prediction</span>
                </div>
                <div class="sensor-value" id="predValue" aria-live="polite">-- <span class="sensor-unit">AQI</span>
                </div>
                <div class="sensor-footer">
                    <span>Next Hour Prediction</span>
                </div>
            </article>

            <article class="sensor-card" aria-labelledby="temp-title">
                <div class="sensor-header">
                    <span class="sensor-title" id="temp-title"><i class="fas fa-thermometer-half"
                            aria-hidden="true"></i>
                        Temperature</span>
                    <span class="aqi-indicator aqi-good" id="tempStatus">Comfortable</span>
                </div>
                <div class="sensor-value" id="tempValue" aria-live="polite">-- <span class="sensor-unit">°C</span></div>
                <div class="sensor-footer">
                    <span>Comfort:</span>
                    <span id="comfortIndex">Calculating...</span>
                </div>
            </article>

            <article class="sensor-card" aria-labelledby="hum-title">
                <div class="sensor-header">
                    <span class="sensor-title" id="hum-title"><i class="fas fa-tint" aria-hidden="true"></i>
                        Humidity</span>
                    <span class="aqi-indicator aqi-good" id="humStatus">Normal</span>
                </div>
                <div class="sensor-value" id="humValue" aria-live="polite">-- <span class="sensor-unit">%</span></div>
                <div class="sensor-footer">
                    <span>Status:</span>
                    <span id="humText">Comfortable</span>
                </div>
            </article>

            <!-- Classroom Performance Index -->
            <article class="sensor-card" aria-labelledby="perf-title">
                <div class="sensor-header">
                    <span class="sensor-title" id="perf-title"><i class="fas fa-graduation-cap" aria-hidden="true"></i>
                        Learning Index</span>
                </div>
                <div class="sensor-value" id="perfScore" aria-live="polite">-- <span class="sensor-unit">%</span></div>
                <div class="sensor-footer">
                    <span id="perfText">Analyzing...</span>
                </div>
            </article>

        </section>

        <!-- Detailed Stats Row -->
        <section class="section"
            style="margin-bottom: 30px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
            <div style="text-align: center;">
                <h4><i class="fas fa-clock"></i> Peak Pollution Time</h4>
                <p id="peakTime" style="font-size: 1.5rem; font-weight: bold;">--:--</p>
            </div>
            <div style="text-align: center;">
                <h4><i class="fas fa-wind"></i> Vent Efficiency</h4>
                <p id="ventEff" style="font-size: 1.5rem; font-weight: bold;">--%</p>
            </div>
            <div style="text-align: center;">
                <h4><i class="fas fa-leaf"></i> Carbon Footprint</h4>
                <p id="carbonFp" style="font-size: 1.5rem; font-weight: bold;">-- kg CO2</p>
            </div>
        </section>

        <section class="section map-container" aria-labelledby="map-heading">
            <h2 id="map-heading"><i class="fas fa-map-marked-alt" aria-hidden="true"></i> Live Sensor Locations</h2>
            <div id="liveMap" aria-label="Interactive map showing sensor locations"></div>
        </section>

        <section class="section sensor-locations" aria-labelledby="locations-heading">
            <h3 id="locations-heading"><i class="fas fa-microchip" aria-hidden="true"></i> Active Sensor Locations</h3>

            <section class="section selector-panel" aria-labelledby="locations-heading">
                <h3 id="locations-heading"><i class="fas fa-university" aria-hidden="true"></i> Campus Navigation</h3>

                <div class="selection-grid">
                    <div class="dropdown-group">
                        <label for="blockSelect">Select Block</label>
                        <select id="blockSelect" class="custom-select">
                            <option value="">-- Select Block --</option>
                        </select>
                    </div>

                    <div class="dropdown-group">
                        <label for="floorSelect">Select Floor</label>
                        <select id="floorSelect" class="custom-select" disabled>
                            <option value="">-- Select Floor --</option>
                        </select>
                    </div>

                    <div class="dropdown-group">
                        <label for="roomSelect">Select Room</label>
                        <select id="roomSelect" class="custom-select" disabled>
                            <option value="">-- Select Room --</option>
                        </select>
                    </div>
                </div>


                <article class="location-card focused-room" id="activeRoomCard">
                    <div class="room-header">
                        <h4 id="currentRoomDisplay">Room A101</h4>
                        <span class="realtime-tag">Monitoring Active</span>
                    </div>
                    <div class="room-stats-grid">
                        <div class="mini-stat"><span>PM2.5:</span> <strong id="roomPm25">--</strong></div>
                        <div class="mini-stat"><span>CO2:</span> <strong id="roomCo2">--</strong></div>
                        <div class="mini-stat"><span>CO:</span> <strong id="roomCo">--</strong></div>
                        <div class="mini-stat"><span>Temp:</span> <strong id="roomTemp">--</strong></div>
                        <div class="mini-stat"><span>Hum:</span> <strong id="roomHum">--</strong></div>
                        <div class="mini-stat"><span>AQI:</span> <strong id="roomAqi">--</strong></div>
                    </div>

                    <!-- New Smart Features -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">

                        <button class="nav-btn" id="exportBtn" style="width: 100%; font-size: 0.8rem;"><i
                                class="fas fa-download"></i> Export Data (CSV)</button>
                    </div>

                </article>
            </section>

            <!-- 30. Green Campus Index -->
            <article class="sensor-card" aria-labelledby="green-title" style="margin-top: 20px;">
                <div class="sensor-header">
                    <span class="sensor-title" id="green-title"><i class="fas fa-leaf" aria-hidden="true"></i> Green
                        Index</span>
                    <span class="aqi-indicator aqi-good" id="greenScore">A+</span>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <p style="font-size: 0.9rem;">Campus Sustainability Score</p>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--success);">92/100</div>
                    <small>Based on CO2 & Energy Efficiency</small>
                </div>
            </article>

            <!-- 15. Real Indoor Compliance (New) -->
            <article class="sensor-card" style="margin-top: 20px; border-left: 5px solid #3b82f6;">
                <h3><i class="fas fa-balance-scale-right"></i> Standards Compliance</h3>
                <div style="margin-top: 10px; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>WHO (PM2.5 < 15):</span>
                                <strong id="complWho" style="color: green;">Pass</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>ASHRAE (CO2 < 1000):</span>
                                <strong id="complAshrae" style="color: green;">Pass</strong>
                    </div>
                </div>
            </article>

            <!-- 10. Academic Impact (New) -->
            <article class="sensor-card" style="margin-top: 20px;">
                <h3><i class="fas fa-brain"></i> Cognitive Impact</h3>
                <p id="cognitionText" style="font-size: 0.9rem; margin-top: 5px;">Optimal learning environment.</p>
                <div class="progress-bar" style="background:#eee; height:10px; border-radius:5px; margin-top:5px;">
                    <div id="cognitionBar" style="width: 100%; height:100%; background: green; border-radius:5px;">
                    </div>
                </div>
                <small style="display:block; text-align:right; margin-top:2px;">Est. Cognitive Loss: <span
                        id="cogLoss">0%</span></small>
            </article>

            <!-- 4. Asthma Mode Toggle -->
            <div
                style="margin-top: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label style="font-weight: bold; color: #d946ef;"><i class="fas fa-lungs"></i> Asthma/Sensitive
                        Mode</label>
                    <label class="switch">
                        <input type="checkbox" id="asthmaToggle">
                        <span class="slider round"></span>
                    </label>
                </div>
                <p id="asthmaText" style="font-size: 0.85rem; color: #666; margin-top: 5px;">Strict alerts for sensitive
                    individuals.</p>
            </div>

        </section>

        </section>

        <section class="chart-grid" aria-labelledby="charts-heading">
            <h2 id="charts-heading" class="visually-hidden">Air Quality Charts</h2>
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3><i class="fas fa-chart-line" aria-hidden="true"></i> Air Quality Trends (Last 24 Hours)</h3>
                    <button class="nav-btn" id="replayBtn" style="font-size: 0.8rem;"><i class="fas fa-play"></i>
                        Replay</button>
                </div>
                <div class="chart-container">
                    <canvas id="trendsChart" aria-label="Line chart of air quality trends"></canvas>
                </div>
            </div>
            <div class="section">
                <h3><i class="fas fa-chart-area" aria-hidden="true"></i> Pollutant Levels</h3>
                <div class="chart-container">
                    <canvas id="pollutantChart" aria-label="Line chart of temperature and humidity"></canvas>
                </div>
            </div>
        </section>

        <section class="section raw-data-panel admin-only" aria-labelledby="raw-heading" style="display: none;">
            <h3 id="raw-heading"><i class="fas fa-code" aria-hidden="true"></i> Raw Sensor Data Stream</h3>
            <div id="rawData" aria-live="polite"></div>
        </section>

        <footer class="last-update" role="contentinfo">
            © 2026 Air Quality Monitoring System | Powered by ESP32 & MQTT
        </footer>
    </div>

    <!-- Chatbot Floating Button -->
    <button class="chat-btn" id="chatFab"><i class="fas fa-robot"></i></button>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="close-btn" id="closeLogin">&times;</button>
            <h2>Select View Mode</h2>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <button class="nav-btn"
                    onclick="AeroAuth.login('student'); document.getElementById('loginModal').style.display='none'">
                    <i class="fas fa-eye"></i> Standard View (Public)</button>
                <button class="nav-btn"
                    onclick="AeroAuth.login('admin'); document.getElementById('loginModal').style.display='none'">
                    <i class="fas fa-tools"></i> Expert View (Admin)</button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <button class="close-btn" id="closeChat">&times;</button>
            <h2 data-i18n="chat">Chat with AeroBot</h2>
            <div id="chatHistory"
                style="height: 300px; overflow-y: auto; background: rgba(0,0,0,0.03); padding: 10px; margin: 15px 0; border-radius: 10px;">
                <div style="margin-bottom: 10px;"><strong>AeroBot:</strong> Hello! How can I help you with air quality
                    today?</div>
            </div>
            <div style="display: flex;">
                <input type="text" id="chatInput" placeholder="Ask about CO2, ranks..."
                    style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                <button class="nav-btn" id="sendChat" style="margin-left: 10px;">Send</button>
            </div>
        </div>
    </div>

    <!-- Admin/Settings Modal (Consolidated) -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="close-btn" id="closeSettings">&times;</button>
            <h2><i class="fas fa-tools"></i> Device Settings & Reports</h2>

            <div class="dashboard"
                style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-top: 20px;">

                <!-- 8. Reports -->
                <article class="sensor-card">
                    <h3><i class="fas fa-file-pdf"></i> Reports</h3>
                    <button class="nav-btn" onclick="AeroAdmin.generateReport('Weekly')"
                        style="margin-top: 10px; width: 100%;">Download Weekly Report</button>
                    <button class="nav-btn" onclick="AeroAdmin.generateReport('Monthly')"
                        style="margin-top: 10px; width: 100%;">Download Monthly Report</button>
                </article>

                <!-- 24. Thresholds -->
                <article class="sensor-card">
                    <h3><i class="fas fa-sliders-h"></i> Thresholds</h3>
                    <div style="margin-top: 10px;">
                        <label>CO2 Alarm (ppm):</label>
                        <input type="number" value="1000" onchange="AeroAdmin.setThreshold('co2', this.value)"
                            style="width: 100%; padding: 5px; margin-bottom: 10px;">
                        <label>PM2.5 Alarm:</label>
                        <input type="number" value="35" onchange="AeroAdmin.setThreshold('pm25', this.value)"
                            style="width: 100%; padding: 5px;">
                    </div>
                </article>

                <!-- 12. Compare Classrooms -->
                <article class="sensor-card" style="grid-column: span 2;">
                    <h3><i class="fas fa-balance-scale"></i> Classroom Comparison</h3>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <select id="compRoom1" class="nav-btn" style="flex:1;">
                            <option>CS Lab 1</option>
                            <option>Lecture Hall A</option>
                        </select>
                        <select id="compRoom2" class="nav-btn" style="flex:1;">
                            <option>Bio Lab 2</option>
                            <option>Library</option>
                        </select>
                        <button class="nav-btn" id="compareBtn"
                            style="background: var(--accent); color: white;">Compare</button>
                    </div>
                    <div id="compareResult"
                        style="margin-top: 15px; display: none; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 8px;">
                        <!-- Results -->
                    </div>
                </article>

                <!-- 29. Audit Log -->
                <article class="sensor-card">
                    <h3><i class="fas fa-history"></i> Audit Log</h3>
                    <ul id="auditLogList"
                        style="list-style: none; padding: 0; margin-top: 10px; font-size: 0.85rem; max-height: 150px; overflow-y: auto;">
                        <!-- Populated by JS -->
                        <li>Loading logs...</li>
                    </ul>
                </article>

            </div>
        </div>
    </div>