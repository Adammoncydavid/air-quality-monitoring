<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Air Quality Monitoring - Real Time Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header Styles (EXISTING) */
    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border-radius: 15px;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header h1 {
      color: #2c3e50;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      /* Title Description Text Color */
      color: #34495e; 
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Status Bar (EXISTING) */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      color: white;
      backdrop-filter: blur(10px);
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff4757;
      animation: pulse 2s infinite;
    }

    .status-dot.connected {
      background: #2ed573;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Dashboard Grid (EXISTING) */
    .dashboard {
      display: grid;
      /* Now showing 4 cards (Temp, Hum, Gas %, Overall AQI) */
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      /* This is now the first content section */
      order: 1; 
    }
    
    /* NEW ORDERING: Sensor Cards first, then Map, then Charts */
    .map-container { order: 2; }
    .chart-grid { order: 3; }
    .sensor-locations { order: 4; }
    .raw-data-panel { order: 5; }

    /* Sensor Cards (EXISTING) */
    .sensor-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .sensor-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .sensor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .sensor-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sensor-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #3498db;
      text-align: center;
      margin: 15px 0;
      transition: all 0.3s ease;
    }
    
    /* Specific styling for the large AQI value */
    #overallAqiValue {
        font-size: 3rem; /* Make the main AQI number stand out */
        font-weight: 900;
    }

    .sensor-unit {
      font-size: 1rem;
      color: #7f8c8d;
      margin-left: 5px;
    }

    .sensor-footer {
      display: flex;
      justify-content: space-between;
      color: #95a5a6;
      font-size: 0.9rem;
    }

    /* AQI Indicators (EXISTING) */
    .aqi-indicator {
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
    }

    .aqi-good { background: #2ecc71; color: white; }
    .aqi-moderate { background: #f39c12; color: white; }
    .aqi-poor { background: #e74c3c; color: white; }
    .aqi-unhealthy { background: #e74c3c; color: white; } 
    .aqi-unhealthy-sensitive { background: #e67e22; color: white; } 

    /* Chart Container (EXISTING but restructured) */
    .chart-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Live Sensor Map Styles (EXISTING) */
    .map-container {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px; 
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .map-container h2 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.5rem;
    }
    #liveMap {
        height: 500px; 
        border-radius: 10px;
    }
    
    /* Chart Grid for 24H Trends and Pollutant Levels (EXISTING) */
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    /* Active Sensors Panel (EXISTING) */
    .sensor-locations {
        background: rgba(255, 255, 255, 0.95);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .sensor-locations h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .location-list {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }
    .location-card {
        flex: 1;
        min-width: 300px;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ddd;
        background: #fdfdfd;
        line-height: 1.5;
    }
    .location-card h4 {
        margin-top: 0;
        color: #34495e;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .realtime-tag {
        background: #e74c3c;
        color: white;
        padding: 2px 8px;
        border-radius: 5px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    .location-card p {
        font-size: 0.9rem;
    }
    .status-text {
        font-weight: 600;
    }
    
    /* Raw Data Panel (EXISTING) */
    .raw-data-panel {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .raw-data-panel h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #rawData {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #e9ecef;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
    }

    .last-update {
      text-align: center;
      color: white;
      opacity: 0.8;
      font-size: 0.9rem;
      margin-top: 20px;
    }

    /* Animation for new data (EXISTING) */
    @keyframes highlight {
      0% { background-color: rgba(46, 204, 113, 0.3); }
      100% { background-color: transparent; }
    }

    .data-update {
      animation: highlight 1s ease;
    }

    /* Responsive Design (EXISTING + Updates for new grids) */
    @media (max-width: 1000px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header {
        padding: 1.5rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .status-bar {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      .location-list {
          flex-direction: column;
      }
      #liveMap {
        height: 300px; /* Smaller map on mobile */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üå§Ô∏è Air Quality Monitoring</h1>
      <p>Real-time Campus Air Quality Monitoring Dashboard</p>
    </div>

    <div class="status-bar">
      <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connecting to MQTT Broker...</span>
      </div>
      <div id="messageCount">Messages Received: 0</div>
    </div>
    
    <div class="dashboard">
      <div class="sensor-card">
        <div class="sensor-header">
          <div class="sensor-title">üå°Ô∏è Temperature</div>
        </div>
        <div class="sensor-value" id="temperature">--</div>
        <div class="sensor-footer">
          <span>Last Updated: <span id="tempTime">--</span></span>
          <span>¬∞C</span>
        </div>
      </div>

      <div class="sensor-card">
        <div class="sensor-header">
          <div class="sensor-title">üíß Humidity</div>
        </div>
        <div class="sensor-value" id="humidity">--</div>
        <div class="sensor-footer">
          <span>Last Updated: <span id="humidityTime">--</span></span>
          <span>%</span>
        </div>
      </div>
      
      <div class="sensor-card">
        <div class="sensor-header">
          <div class="sensor-title">‚òÅÔ∏è Gas Concentration</div>
          <div class="aqi-indicator" id="gasAqi">--</div>
        </div>
        <div class="sensor-value" id="gasPercent">--</div>
        <div class="sensor-footer">
          <span>Last Updated: <span id="gasTime">--</span></span>
          <span>%</span>
        </div>
      </div>

      <div class="sensor-card">
        <div class="sensor-header">
          <div class="sensor-title">üåê Overall AQI</div>
          <div class="aqi-indicator" id="overallAqiStatus">--</div>
        </div>
        <div class="sensor-value" id="overallAqiValue">--</div> 
        <div class="sensor-footer">
          <span>Last Updated: <span id="aqiTime">--</span></span>
          <span>Index</span>
        </div>
      </div>
    </div>
    
    <div class="map-container">
        <h2>Live Sensor Map LIVE</h2>
        <div id="liveMap"></div>
    </div>
    
    <div class="chart-grid">
        <div class="chart-container">
            <h4>Air Quality Trends (Last 24 Hours)</h4>
            <canvas id="trendsChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h4>Temperature, Humidity, and Gas % Levels</h4>
            <canvas id="pollutantChart"></canvas>
        </div>
    </div>

    <div class="sensor-locations">
        <h3>Active Sensors <span class="realtime-tag">Real Time</span></h3>
        <div class="location-list" id="activeSensorList">
            
            <div class="location-card" id="canteenSensorCard">
                <h4>Canteen <span class="aqi-indicator aqi-good">AQI: 45</span></h4>
                <p>Temp: <span id="canteenTemp">28</span>¬∞C | Humidity: <span id="canteenHum">75</span>% | Gas: <span id="canteenGas">5</span>%</p>
                <p>Status: <span class="status-text aqi-good">GOOD</span> | DLMO</p>
                <p class="sensor-footer" style="margin-top: 5px;">Updated <span id="canteenTime">11:32:19 AM</span></p>
            </div>
            
            <div class="location-card" id="librarySensorCard">
                <h4>Library <span class="aqi-indicator aqi-moderate">AQI: 68</span></h4>
                <p>Temp: <span id="libraryTemp">29</span>¬∞C | Humidity: <span id="libraryHum">72</span>% | Gas: <span id="libraryGas">10</span>%</p>
                <p>Status: <span class="status-text aqi-moderate">MODERATE</span> | DLMO</p>
                <p class="sensor-footer" style="margin-top: 5px;">Updated <span id="libraryTime">1:39:10 AM</span></p>
            </div>
        </div>
    </div>

    <div class="raw-data-panel">
      <h3>üìä Live MQTT Raw Data</h3>
      <pre id="rawData">Waiting for data...</pre>
    </div>

    <div class="last-update" id="lastUpdate">
      System Ready - Waiting for sensor data...
    </div>
  </div>

  <script>
    // MQTT Configuration (EXISTING)
    const config = {
      broker: "wss://cd29a7c955164a079ab779cab2f382d7.s1.eu.hivemq.cloud:8884/mqtt",
      username: "adam1234",
      password: "Adam1234",
      topic: "esp32/sensor"
    };

    // Global variables (MODIFIED: Removed pm10 from history)
    let messageCount = 0;
    let dataHistory = {
      temperature: [],
      humidity: [],
      gas: [],
      // pm10: [], // REMOVED
      timestamps: []
    };
    const MAX_HISTORY = 15;

    // Chart instances (EXISTING)
    let mainChart, trendsChart, pollutantChart, liveMap;

    // Initialize MQTT Client (EXISTING)
    const client = mqtt.connect(config.broker, {
      username: config.username,
      password: config.password,
      clean: true,
      reconnectPeriod: 2000,
      connectTimeout: 5000
    });

    // Connection event handlers (EXISTING)
    client.on("connect", () => {
      console.log("‚úÖ Connected to MQTT broker!");
      updateStatus(true, "Connected to HiveMQ Cloud");
      client.subscribe(config.topic, { qos: 1 });
      console.log("‚úÖ Subscribed to topic: " + config.topic);
    });

    client.on("message", (topic, message) => {
      const messageString = message.toString();
      
      messageCount++;
      document.getElementById('messageCount').textContent = "Messages Received: " + messageCount;
      document.getElementById('rawData').innerText = `Topic: ${topic}\n\nData: ${messageString}`;
      
      try {
        const data = JSON.parse(messageString);
        
        if (topic === config.topic) {
            updateDashboard(data);
            updateChart(data); 
            // Use main data for Canteen/Active Sensor 
            updateLocationData('canteen', data); 
        }
        
        updateMapMarkers(data);

        document.getElementById('rawData').classList.add('data-update');
        setTimeout(() => {
          document.getElementById('rawData').classList.remove('data-update');
        }, 1000);
        
      } catch (error) {
        console.error("‚ùå Error parsing JSON:", error);
        displayRawData(messageString);
      }
    });

    client.on("error", (err) => {
      updateStatus(false, "Connection Error: " + err.message);
    });

    client.on("offline", () => {
      updateStatus(false, "Connection Lost - Reconnecting...");
    });

    client.on("reconnect", () => {
      updateStatus(false, "Reconnecting to broker...");
    });

    // Update dashboard with parsed data (MODIFIED for Gas % and Overall AQI)
    function updateDashboard(data) {
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      
      // Update Temperature
      const tempVal = data.temperature !== undefined ? data.temperature : (data.temp !== undefined ? data.temp : null);
      if (tempVal !== null) {
        updateSensorValue('temperature', tempVal.toFixed(1), '¬∞C', timeString, 'tempTime');
      }
      
      // Update Humidity
      const humVal = data.humidity !== undefined ? data.humidity : (data.hum !== undefined ? data.hum : null);
      if (humVal !== null) {
        updateSensorValue('humidity', humVal.toFixed(1), '%', timeString, 'humidityTime');
      }
      
      // Update Gas % 
      const gasVal = data.gas !== undefined ? data.gas : (data.mq135 !== undefined ? data.mq135 : 0);
      if (gasVal !== null) {
        updateSensorValue('gasPercent', gasVal.toFixed(1), '%', timeString, 'gasTime');
        updateAqiIndicator('gasAqi', gasVal, 'gas'); // Gas status/quality indicator
      }
      
      // NEW: Calculate and update Overall AQI (Based on Gas data, as it's the primary air quality metric available)
      const aqiVal = gasVal !== null ? calculateAQI(gasVal) : 0;
      updateSensorValue('overallAqiValue', aqiVal.toFixed(0), 'Index', timeString, 'aqiTime');
      updateAqiIndicator('overallAqiStatus', aqiVal, 'aqi'); // Overall AQI status indicator
      
      document.getElementById('lastUpdate').textContent = 
        "Last Update: " + now.toLocaleString() + " - ‚úÖ Data Received!";
    }

    // Update location-specific data (MODIFIED: Removed PM data)
    function updateLocationData(locationId, data) {
        const timeString = new Date().toLocaleTimeString();
        
        // Use the main dashboard data for the Canteen card
        if (locationId === 'canteen') {
            const tempVal = data.temperature || data.temp;
            const humVal = data.humidity || data.hum;
            const gasVal = data.gas || data.mq135;
            const aqiValue = gasVal !== undefined ? calculateAQI(gasVal) : 45; // Calculate from gas
            
            if (tempVal !== undefined) document.getElementById(`${locationId}Temp`).textContent = tempVal.toFixed(1);
            if (humVal !== undefined) document.getElementById(`${locationId}Hum`).textContent = humVal.toFixed(1);
            if (gasVal !== undefined) document.getElementById(`${locationId}Gas`).textContent = gasVal.toFixed(1);

            document.getElementById(`${locationId}Time`).textContent = timeString;
            
            // Simplified AQI Status Update
            const aqiElement = document.querySelector(`#${locationId}SensorCard h4 .aqi-indicator`);
            const statusElement = document.querySelector(`#${locationId}SensorCard p .status-text`);
            
            let status = aqiValue <= 50 ? 'GOOD' : (aqiValue <= 100 ? 'MODERATE' : 'POOR');
            let className = aqiValue <= 50 ? 'aqi-good' : (aqiValue <= 100 ? 'aqi-moderate' : 'aqi-poor');
            
            aqiElement.textContent = `AQI: ${aqiValue.toFixed(0)}`;
            aqiElement.className = `aqi-indicator ${className}`;
            statusElement.textContent = status;
            statusElement.className = `status-text ${className}`;
        } 
        
        // The 'library' card remains on placeholder/fixed data for now.
    }


    // Helper function to update sensor values with animation (EXISTING)
    function updateSensorValue(sensorId, value, unit, time, timeElementId) {
      const element = document.getElementById(sensorId);
      const timeElement = document.getElementById(timeElementId);
      
      element.classList.add('data-update');
      setTimeout(() => {
        element.classList.remove('data-update');
      }, 1000);
      
      element.textContent = value;
      timeElement.textContent = time;
    }

    // Update AQI indicators (MODIFIED to include General AQI logic)
    function updateAqiIndicator(elementId, value, type) {
      const element = document.getElementById(elementId);
      let status, className;
      
      if (type === 'gas') {
        // Simple Gas % logic (low is good, high is poor)
        if (value <= 5) { status = "Low"; className = "aqi-good"; }
        else if (value <= 15) { status = "Med"; className = "aqi-moderate"; }
        else { status = "High"; className = "aqi-poor"; }
      } else if (type === 'aqi') {
        // General AQI status based on the calculated AQI value
        if (value <= 50) { status = "GOOD"; className = "aqi-good"; }
        else if (value <= 100) { status = "MODERATE"; className = "aqi-moderate"; }
        else { status = "POOR"; className = "aqi-poor"; }
      } else {
        // Fallback for any other type (e.g., PM10 remnants)
        status = "N/A"; className = "aqi-moderate";
      }
      
      element.textContent = status;
      element.className = "aqi-indicator " + className;
    }

    // Display raw data if JSON parsing fails (MODIFIED: Removed PM10)
    function displayRawData(rawString) {
      document.getElementById('temperature').textContent = "RAW";
      document.getElementById('humidity').textContent = "DATA";
      document.getElementById('gasPercent').textContent = "RECEIVED";
      document.getElementById('overallAqiValue').textContent = "‚úì";
      
      const now = new Date().toLocaleTimeString();
      document.getElementById('tempTime').textContent = now;
      document.getElementById('humidityTime').textContent = now;
      document.getElementById('gasTime').textContent = now;
      document.getElementById('aqiTime').textContent = now;
    }

    // Update connection status (EXISTING)
    function updateStatus(connected, message) {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      
      if (connected) {
        statusDot.classList.add('connected');
        statusText.textContent = "‚úÖ " + message;
      } else {
        statusDot.classList.remove('connected');
        statusText.textContent = "‚ùå " + message;
      }
    }
    
    // Calculate a simple AQI for the trends chart from a generic sensor value (Gas %) (EXISTING)
    function calculateAQI(gasValue) {
        // Assuming a mapping where 0-10% is good (0-50 AQI), 10-30% is moderate (50-100 AQI).
        if (gasValue <= 10) return Math.floor(gasValue * 5); // 0 -> 50
        if (gasValue <= 30) return Math.floor(50 + (gasValue - 10) * 2.5); // 50 -> 100
        return 100 + Math.floor((gasValue - 30) * 1.5); // >100
    }

    // Initialize Leaflet Map (MODIFIED: New Coordinates)
    function initializeMap() {
        // New center based on the provided Canteen/Library coordinates
        const centerLat = 9.21175; 
        const centerLon = 76.64215; 
        
        liveMap = L.map('liveMap', {
            center: [centerLat, centerLon],
            zoom: 18 // Increased zoom for campus view
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(liveMap);
        
        updateMapMarkers();
    }
    
    // Update map markers (MODIFIED: New Canteen/Library Coordinates)
    let mapMarkers = {};
    function updateMapMarkers(latestData = {}) {
        Object.values(mapMarkers).forEach(marker => liveMap.removeLayer(marker));
        mapMarkers = {};
        
        // MODIFIED: New Canteen/Library coordinates from user request
        const markers = [
            { lat: 9.211590667984765, lon: 76.64213713726257, value: 45, color: 'green', name: 'Library' },
            { lat: 9.21189911545929, lon: 76.64217468818647, value: 68, color: 'orange', name: 'Canteen' },
            // Keeping other markers for initial visual consistency, use old placeholder coords
            { lat: 9.2125, lon: 76.6415, value: 28, color: 'green', name: 'Hostel' },
            { lat: 9.2110, lon: 76.6430, value: 198, color: 'red', name: 'Main Gate' }
        ];

        markers.forEach(m => {
            let color;
            if (m.value <= 50) color = '#2ecc71'; // Good/Green
            else if (m.value <= 100) color = '#f39c12'; // Moderate/Yellow-Orange
            else color = '#e74c3c'; // Poor/Red
            
            const markerHtmlStyles = `
                background-color: ${color};
                width: 30px;
                height: 30px;
                display: flex;
                justify-content: center;
                align-items: center;
                border-radius: 50%;
                color: white;
                font-weight: bold;
                border: 3px solid white;
                box-shadow: 0 0 5px rgba(0,0,0,0.5);
            `;
            
            const customIcon = L.divIcon({
                className: "custom-div-icon",
                html: `<div style="${markerHtmlStyles}">${m.value}</div>`,
                iconSize: [30, 42],
                iconAnchor: [15, 21]
            });
            
            const marker = L.marker([m.lat, m.lon], { icon: customIcon })
                .bindPopup(`<b>${m.name}</b><br>AQI: ${m.value}`);
                
            marker.addTo(liveMap);
            mapMarkers[m.name] = marker;
        });
    }

    // Helper to generate past time labels (EXISTING)
    function getPastHourLabels(count) {
        const labels = [];
        const now = new Date();
        for (let i = count - 1; i >= 0; i--) {
            const time = new Date(now.getTime() - i * 60000); 
            labels.push(time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
        }
        return labels;
    }


    // Initialize and manage the charts (EXISTING)
    function initializeChart() {
      
      // 1. Air Quality Trends (Last 24 Hours)
      const ctxTrends = document.getElementById('trendsChart').getContext('2d');
      trendsChart = new Chart(ctxTrends, {
        type: 'line',
        data: {
          labels: getPastHourLabels(6), 
          datasets: [
            {
              label: 'AQI (Gas-Derived)',
              data: [95, 60, 100, 70, 65, 65], 
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.3)',
              fill: true,
              tension: 0.4,
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: false, min: 0, max: 120, title: { display: true, text: 'AQI' } }
          },
          plugins: { legend: { display: false } }
        }
      });
      
      // 2. Pollutant Levels (T, H, Gas %)
      const ctxPollutant = document.getElementById('pollutantChart').getContext('2d');
      pollutantChart = new Chart(ctxPollutant, {
        type: 'line',
        data: {
          labels: getPastHourLabels(6), 
          datasets: [
            {
              label: 'Temperature (¬∞C)',
              data: [20, 30, 20, 28, 27, 25], 
              borderColor: '#e74c3c', 
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              tension: 0.4,
              yAxisID: 'y'
            },
            {
              label: 'Humidity (%)',
              data: [80, 70, 85, 75, 78, 79], 
              borderColor: '#3498db', 
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              tension: 0.4,
              yAxisID: 'y1' 
            },
            {
              label: 'Gas (%)',
              data: [5, 10, 8, 12, 15, 10], 
              borderColor: '#2ecc71', 
              backgroundColor: 'rgba(46, 204, 113, 0.1)',
              tension: 0.4,
              yAxisID: 'y1' 
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: false, position: 'left', title: { display: true, text: 'Temp (¬∞C)' }, min: 15, max: 40 },
            y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Humidity / Gas (%)' }, grid: { drawOnChartArea: false }, min: 0, max: 100 }
          }
        }
      });
    }

    // Update chart with new data (MODIFIED: Removed PM10 from history update)
    function updateChart(data) {
      const now = new Date();
      const timeLabel = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      const tempVal = data.temperature || data.temp;
      const humVal = data.humidity || data.hum;
      const gasVal = data.gas || data.mq135;
      
      // Update data history
      if (tempVal !== undefined) dataHistory.temperature.push(tempVal);
      if (humVal !== undefined) dataHistory.humidity.push(humVal);
      if (gasVal !== undefined) dataHistory.gas.push(gasVal);
      dataHistory.timestamps.push(timeLabel);
      
      // Limit history size
      if (dataHistory.timestamps.length > MAX_HISTORY) {
        dataHistory.timestamps.shift();
        dataHistory.temperature.shift();
        dataHistory.humidity.shift();
        dataHistory.gas.shift(); 
      }
      
      // 1. Update AQI Trends Chart (Gas-Derived AQI)
      if (trendsChart && gasVal !== undefined) {
          trendsChart.data.labels = dataHistory.timestamps;
          trendsChart.data.datasets[0].data = dataHistory.gas.map(g => calculateAQI(g)); 
          trendsChart.update('none'); 
      }
      
      // 2. Update Pollutant Levels Chart (T, H, Gas %)
      if (pollutantChart && tempVal !== undefined && humVal !== undefined && gasVal !== undefined) {
          pollutantChart.data.labels = dataHistory.timestamps;
          pollutantChart.data.datasets[0].data = dataHistory.temperature;
          pollutantChart.data.datasets[1].data = dataHistory.humidity;
          pollutantChart.data.datasets[2].data = dataHistory.gas;
          pollutantChart.update('none');
      }
    }

    // Initialize everything when page loads (EXISTING)
    window.addEventListener('load', function() {
      initializeMap(); 
      initializeChart(); 
      
      // Initial state for Canteen (Main reading)
      updateLocationData('canteen', { temperature: 29.4, humidity: 87.7, gas: 5, aqi: 45 }); 
      
      // Initial state for Library (Placeholder/Fixed data)
      updateLocationData('library', { temperature: 28.5, humidity: 75.0, gas: 10, aqi: 68 });
      
      // Pre-fill initial charts with some data for better visualization
      const initialLabels = getPastHourLabels(MAX_HISTORY);
      const initialGas = [5, 6, 8, 10, 12, 10, 9, 7, 6, 5, 8, 11, 15, 13, 11]; // Example Gas data
      const initialTemp = [25, 26, 27, 28, 29, 29, 28, 27, 26, 25, 27, 28, 29, 28, 27];
      const initialHum = [70, 72, 75, 78, 80, 80, 78, 75, 72, 70, 75, 78, 82, 80, 78];

      dataHistory.timestamps = initialLabels;
      dataHistory.temperature = initialTemp;
      dataHistory.humidity = initialHum;
      dataHistory.gas = initialGas;
      
      trendsChart.data.labels = initialLabels;
      trendsChart.data.datasets[0].data = initialGas.map(g => calculateAQI(g));
      trendsChart.update('none');

      pollutantChart.data.labels = initialLabels;
      pollutantChart.data.datasets[0].data = initialTemp;
      pollutantChart.data.datasets[1].data = initialHum;
      pollutantChart.data.datasets[2].data = initialGas;
      pollutantChart.update('none');
      
      // Update the main AQI card with initial data
      const initialAqi = calculateAQI(initialGas[initialGas.length - 1]);
      updateSensorValue('overallAqiValue', initialAqi.toFixed(0), 'Index', new Date().toLocaleTimeString(), 'aqiTime');
      updateAqiIndicator('overallAqiStatus', initialAqi, 'aqi');

      console.log("üöÄ Air Quality Dashboard Initialized!");
    });

    // Add manual test function for debugging (MODIFIED: Removed PM10)
    window.testWithSampleData = function() {
      const testData = {
        temperature: 25.0 + Math.random() * 5,
        humidity: 60 + Math.random() * 30,
        gas: 5 + Math.random() * 15, // Simulate MQ135 reading 5% to 20%
        // pm10: 20 + Math.random() * 30 // PM10 removed from test
      };
      updateDashboard(testData);
      updateChart(testData);
      updateMapMarkers(testData); 
    };
  </script>
</body>
</html>